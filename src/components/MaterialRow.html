<tr class="{open ? 'open' : ''}">
  <td>{material.title}</td>
  <td>{material.type}</td>
  <td on:click="set({open: !open})" class="expand">
    <i class="material-icons">
      {#if open}
      expand_less
      {:else}
      expand_more
      {/if}
    </i>
  </td>
</tr>
{#if open}
<tr class="details">
  <td colspan="3">
    <p><a href="{material.uri}">URI: {material.uri}</a></p>
    {#if material.notes}
    <p>Notes: {material.notes}</p>
    {/if}
    {#if simpletype === 'video'}
    <video controls crossorigin playsinline>
      <source src="{material.uri}" type="{material.type}" />
    </video>
    {:elseif simpletype === 'audio'}
    <audio controls src="{material.uri}"></audio>
    {:elseif simpletype === 'image'}
    <img src="{material.uri}" alt="{material.title}" />
    {/if}

    <h3>Related Lessons</h3>
    {#await lessons}
    <p>Loading related lessons...</p>
    {:then answer}
    <p>{answer.total} lessons</p>
    {#each answer.data as lesson (lesson._id)}
    <li>
      <a href="/lessons/{lesson._id}">
        {group(lesson, $groups).name} class lesson {lesson.number}
      </a>
    </li>
    {/each}
    {:catch error}
    <p>Couldn't fetch related lessons: {error}</p>
    {/await}
  </td>
</tr>
{/if}

<style>
  tr.open td {
    border: none;
  }

  .expand {
    cursor: pointer;
  }
</style>

<script>
  export default {
    data() {
      return {
        open: false
      };
    },
    computed: {
      simpletype: ({ material }) => {
        if (!material.type) return "";
        return material.type.split("/")[0];
      },
      lessons: ({ material }) =>
        client.service("lessons").find({ query: { materials: material._id } })
    },
    helpers: {
      group: (lesson, groups) => {
        if (groups) return groups.find(group => group._id === lesson.group);
      }
    }
  };
</script>